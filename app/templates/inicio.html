{% extends "base.html" %}

{% block title %}Dashboard // The Apex{% endblock %}

{% block content %}
<!-- Top Header Area -->
<div class="header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 35px; background: rgba(255,255,255,0.02); padding: 25px; border-radius: 20px; border: 1px solid var(--glass-border); backdrop-filter: blur(10px);">
    <div style="display: flex; align-items: center; gap: 20px;">
        <div style="width: 54px; height: 54px; background: var(--accent-color); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 26px; box-shadow: 0 8px 20px var(--accent-glow);">
            <i class="bi bi-speedometer2"></i>
        </div>
        <div>
            <h1 style="font-size: 26px; font-weight: 800; letter-spacing: -0.5px; margin: 0; color: #fff;">Dashboard Central</h1>
            <div style="display: flex; align-items: center; gap: 12px; margin-top: 5px;">
                <span style="color: var(--text-secondary); font-size: 13px; display: flex; align-items: center; gap: 5px;">
                    <i class="bi bi-clock-history"></i> Última atualização: {{ now | strftime('%H:%M:%S') if now else 'Recém atualizado' }}
                </span>
                <span style="width: 4px; height: 4px; background: var(--glass-border); border-radius: 50%;"></span>
                <span style="color: #198754; font-size: 13px; font-weight: 600; display: flex; align-items: center; gap: 5px;">
                    <i class="bi bi-shield-fill-check"></i> Proteção Ativa
                </span>
            </div>
        </div>
    </div>
    
    <div style="display: flex; gap: 15px; align-items: center;">
        <div style="text-align: right; margin-right: 5px;">
            <div style="font-size: 12px; color: var(--text-secondary); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Status Global</div>
            <div style="font-size: 14px; color: #fff; font-weight: 700;">{{ stats.analises }} Análises</div>
        </div>
        <div class="status-badge" style="background: rgba(25, 135, 84, 0.1); color: #198754; border: 1px solid rgba(25, 135, 84, 0.2); padding: 10px 18px; border-radius: 14px; font-size: 12px; font-weight: 700;">
            <i class="bi bi-hdd-network-fill" style="margin-right: 8px;"></i> SISTEMA ONLINE
        </div>
    </div>
</div>

<!-- Stats Grid -->
<div class="stat-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 35px;">
    <div class="stat-card red" style="background: linear-gradient(135deg, rgba(220, 53, 69, 0.2), rgba(220, 53, 69, 0.05)); border: 1px solid rgba(220, 53, 69, 0.3); padding: 20px; border-radius: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">Malwares</div>
            <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(220, 53, 69, 0.2); display: flex; align-items: center; justify-content: center; color: #ff4d4d;">
                <i class="bi bi-bug-fill"></i>
            </div>
        </div>
        <div style="font-size: 32px; font-weight: 700; color: #ff4d4d;">{{ stats.criticos if stats and stats.criticos is defined else 0 }}</div>
        <div style="font-size: 11px; color: #ff4d4d; margin-top: 8px; font-weight: 600;">CRÍTICO</div>
    </div>
    
    <div class="stat-card yellow" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.2), rgba(255, 193, 7, 0.05)); border: 1px solid rgba(255, 193, 7, 0.3); padding: 20px; border-radius: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">Suspeitos</div>
            <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(255, 193, 7, 0.2); display: flex; align-items: center; justify-content: center; color: #ffc107;">
                <i class="bi bi-exclamation-triangle-fill"></i>
            </div>
        </div>
        <div style="font-size: 32px; font-weight: 700; color: #ffc107;">{{ stats.alertas if stats and stats.alertas is defined else 0 }}</div>
        <div style="font-size: 11px; color: #ffc107; margin-top: 8px; font-weight: 600;">ATENÇÃO</div>
    </div>

    <div class="stat-card blue" style="background: linear-gradient(135deg, rgba(13, 110, 253, 0.2), rgba(13, 110, 253, 0.05)); border: 1px solid rgba(13, 110, 253, 0.3); padding: 20px; border-radius: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">Total Análises</div>
            <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(13, 110, 253, 0.2); display: flex; align-items: center; justify-content: center; color: #0d6efd;">
                <i class="bi bi-search"></i>
            </div>
        </div>
        <div style="font-size: 32px; font-weight: 700; color: #0d6efd;">{{ stats.analises if stats and stats.analises is defined else 0 }}</div>
        <div style="font-size: 11px; color: #0d6efd; margin-top: 8px; font-weight: 600;">HISTÓRICO</div>
    </div>

    <div class="stat-card green" style="background: linear-gradient(135deg, rgba(25, 135, 84, 0.2), rgba(25, 135, 84, 0.05)); border: 1px solid rgba(25, 135, 84, 0.3); padding: 20px; border-radius: 16px;">
        <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div style="font-size: 13px; color: var(--text-secondary); font-weight: 500;">Limpos</div>
            <div style="width: 32px; height: 32px; border-radius: 8px; background: rgba(25, 135, 84, 0.2); display: flex; align-items: center; justify-content: center; color: #198754;">
                <i class="bi bi-shield-check"></i>
            </div>
        </div>
        <div style="font-size: 32px; font-weight: 700; color: #198754;">{{ stats.resolvidos if stats and stats.resolvidos is defined else 0 }}</div>
        <div style="font-size: 11px; color: #198754; margin-top: 8px; font-weight: 600;">SEGURO</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 24px;">
    <!-- Coluna da Esquerda: Atividade -->
    <div class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
            <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Atividade de Alertas (Histórico)</h3>
            <span style="color: #198754; font-size: 12px; font-weight: 700;">Ativo <i class="bi bi-activity"></i></span>
        </div>
        
        <!-- Gráfico de Atividade (Barras Reais) -->
        <div style="display: flex; align-items: flex-end; gap: 10px; height: 120px; padding-bottom: 10px; margin-top: 10px;">
            {% set chart_vals = stats.chart_data if stats and stats.chart_data else [0,0,0,0,0,0,0] %}
            {% set max_val = chart_vals | max if chart_vals else 1 %}
            {% set max_val = max_val if max_val > 0 else 1 %}
            
            {% for val in chart_vals %}
                {% set height_pct = ((val / max_val) * 100) | round | int %}
                <div style="flex: 1; display: flex; flex-direction: column; align-items: center; gap: 5px;">
                    <div style="width: 100%; background: {{ 'var(--accent-color)' if val > 0 else 'rgba(0, 123, 255, 0.1)' }}; 
                                height: {{ height_pct if height_pct > 5 else 5 }}%; 
                                border-radius: 6px; 
                                position: relative;
                                transition: all 0.3s ease;
                                {{ 'box-shadow: 0 0 15px var(--accent-glow);' if val > 0 else '' }}"
                         title="{{ val }} alertas">
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <div style="display: flex; justify-content: space-between; margin-top: 5px; color: var(--text-secondary); font-size: 10px; padding: 0 5px;">
            <span>7 dias atrás</span>
            <span>Hoje</span>
        </div>
        
        <div style="margin-top: 25px; border-top: 1px solid var(--glass-border); padding-top: 20px;">
            <h4 style="font-size: 14px; margin-bottom: 15px; color: #fff;">Módulos Disponíveis</h4>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <a href="{{ url_for('main.index') }}?module=malware" style="text-decoration: none; padding: 15px; background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 12px; display: block; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                    <i class="bi bi-bug-fill" style="color: #ff4d4d; margin-right: 8px;"></i>
                    <span style="color: #fff; font-size: 13px; font-weight: 500;">Malware Analyzer</span>
                </a>
                <a href="{{ url_for('main.index') }}?module=network" style="text-decoration: none; padding: 15px; background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 12px; display: block; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                    <i class="bi bi-broadcast-pin" style="color: var(--accent-color); margin-right: 8px;"></i>
                    <span style="color: #fff; font-size: 13px; font-weight: 500;">Network Monitor</span>
                </a>
                <a href="{{ url_for('main.index') }}?module=alerts" style="text-decoration: none; padding: 15px; background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 12px; display: block; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                    <i class="bi bi-bell-fill" style="color: #00d4ff; margin-right: 8px;"></i>
                    <span style="color: #fff; font-size: 13px; font-weight: 500;">Alertas Brasil</span>
                </a>
                <a href="{{ url_for('main.index') }}?module=audit" style="text-decoration: none; padding: 15px; background: rgba(255,255,255,0.02); border: 1px solid var(--glass-border); border-radius: 12px; display: block; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='rgba(255,255,255,0.02)'">
                    <i class="bi bi-shield-lock-fill" style="color: #ffc107; margin-right: 8px;"></i>
                    <span style="color: #fff; font-size: 13px; font-weight: 500;">Windows Audit</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Coluna da Direita: Alertas Recentes -->
    <div class="glass-card" style="padding: 20px;">
        <h3 style="margin: 0 0 20px 0; font-size: 16px; font-weight: 600;">Alertas Recentes</h3>
        
        <div style="display: flex; flex-direction: column; gap: 12px;">
            {% if stats and stats.recentes %}
                {% for alerta in stats.recentes %}
                <!-- Alerta Real -->
                <a href="{{ url_for('main.results', report_id=alerta.id) }}" style="text-decoration: none; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 12px; border: 1px solid var(--glass-border); display: flex; align-items: center; gap: 12px; transition: all 0.2s;" onmouseover="this.style.borderColor='var(--accent-color)'" onmouseout="this.style.borderColor='var(--glass-border)'">
                    <div style="width: 8px; height: 8px; border-radius: 50%; 
                        {% if alerta.final_verdict == 'malicious' %}background: #ff4d4d; box-shadow: 0 0 8px #ff4d4d;
                        {% elif alerta.final_verdict == 'suspicious' %}background: #ffc107; box-shadow: 0 0 8px #ffc107;
                        {% else %}background: #198754; box-shadow: 0 0 8px #198754;{% endif %}">
                    </div>
                    <div style="flex: 1;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 13px; font-weight: 600; color: #fff; max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ alerta.item_identifier }}
                            </span>
                            <span style="font-size: 10px; color: var(--text-secondary);">{{ alerta.created_at | strftime('%H:%M') }}</span>
                        </div>
                        <div style="font-size: 11px; color: var(--text-secondary);">{{ alerta.item_type | capitalize }}</div>
                    </div>
                </a>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 40px 20px; color: var(--text-secondary);">
                    <i class="bi bi-shield-slash" style="font-size: 32px; display: block; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p style="font-size: 13px;">Nenhuma análise recente encontrada.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
