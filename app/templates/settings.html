{% extends "base.html" %}

{% block title %}Configurações{% endblock %}

{% block content %}
<div class="header">
    <h1>Configurações de Chaves de API</h1>
    <p style="color: var(--text-secondary);">Gerencie as chaves de API usadas para se conectar aos serviços externos.</p>
</div>

<div id="alert-placeholder"></div>

<div class="glass-card">
    <form id="settings-form" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        
        <!-- Seção de IA -->
        <div style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px; font-weight: 400; color: #fff; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
                Inteligência Artificial (Groq apenas)
            </h3>
            
            <div class="mb-3">
                <label for="AI_API_KEY" class="form-label">Chave da API da Groq</label>
                <input type="password" class="form-control" id="AI_API_KEY" name="AI_API_KEY" placeholder="Cole sua chave aqui para salvar ou atualizar">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Chave atual: <span class="font-monospace">{{ key_status.AI_API_KEY }}</span>
                </div>
            </div>
        </div>

        <!-- Seção de Outros Serviços -->
        <div style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px; font-weight: 400; color: #fff; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
                Outros Serviços
            </h3>

            <div class="mb-3">
                <label for="VT_API_KEY" class="form-label">Chave da API do VirusTotal</label>
                <input type="password" class="form-control" id="VT_API_KEY" name="VT_API_KEY" placeholder="Deixe em branco para não alterar">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Chave atual: <span class="font-monospace">{{ key_status.VT_API_KEY }}</span>
                </div>
            </div>

            <div class="mb-3">
                <label for="OSM_API_KEY" class="form-label">Chave da API do OpenSourceMalware.com</label>
                <input type="password" class="form-control" id="OSM_API_KEY" name="OSM_API_KEY" placeholder="Deixe em branco para não alterar">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Chave atual: <span class="font-monospace">{{ key_status.OSM_API_KEY }}</span>
                </div>
            </div>

            <div class="mb-3">
                <label for="GOOGLE_SAFE_BROWSING_API_KEY" class="form-label">Chave da API do Google Safe Browsing</label>
                <input type="password" class="form-control" id="GOOGLE_SAFE_BROWSING_API_KEY" name="GOOGLE_SAFE_BROWSING_API_KEY" placeholder="Deixe em branco para não alterar">
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Chave atual: <span class="font-monospace">{{ key_status.GOOGLE_SAFE_BROWSING_API_KEY }}</span>
                </div>
            </div>
        </div>

        <!-- Seção de Integrações SIEM/SOAR -->
        <div style="margin-bottom: 30px;">
            <h3 style="margin-bottom: 15px; font-weight: 400; color: #fff; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px;">
                Integrações SIEM/SOAR (Elastic & Wazuh Gratuitos)
            </h3>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Elastic -->
                <div class="mb-3">
                    <label for="ELASTIC_API_KEY" class="form-label">Elastic API Key</label>
                    <input type="password" class="form-control" id="ELASTIC_API_KEY" name="ELASTIC_API_KEY" placeholder="API Key do seu Elastic local">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                        Chave atual: <span class="font-monospace">{{ key_status.ELASTIC_API_KEY }}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="ELASTIC_API_URL" class="form-label">Elasticsearch URL</label>
                    <input type="text" class="form-control" id="ELASTIC_API_URL" name="ELASTIC_API_URL" placeholder="http://localhost:9200">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                        URL atual: <span class="font-monospace">{{ key_status.ELASTIC_API_URL }}</span>
                    </div>
                </div>
                
                <!-- Wazuh -->
                <div class="mb-3">
                    <label for="WAZUH_API_KEY" class="form-label">Wazuh API Key</label>
                    <input type="password" class="form-control" id="WAZUH_API_KEY" name="WAZUH_API_KEY" placeholder="Token de autenticação do Wazuh">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                        Chave atual: <span class="font-monospace">{{ key_status.WAZUH_API_KEY }}</span>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="WAZUH_API_URL" class="form-label">Wazuh API URL</label>
                    <input type="text" class="form-control" id="WAZUH_API_URL" name="WAZUH_API_URL" placeholder="https://localhost:55000">
                    <div style="font-size: 11px; color: var(--text-secondary); margin-top: 5px;">
                        URL atual: <span class="font-monospace">{{ key_status.WAZUH_API_URL }}</span>
                    </div>
                </div>
            </div>
        </div>

        <button type="submit" class="action-btn" id="save-button" style="width: 100%;">
            <span id="btn-text">Salvar Alterações</span>
            <span id="btn-spinner" class="d-none" style="margin-left: 10px;">⏳</span>
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Função auxiliar para mostrar alertas no estilo novo
    window.showAlert = function(message, type, placeholder) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = [
            `<div class="alert alert-${type} fade show" role="alert" style="display: flex; justify-content: space-between; align-items: center;">`,
            `   <div>${message}</div>`,
            `   <button type="button" onclick="this.parentElement.remove()" style="background:none; border:none; color:inherit; font-size: 20px; cursor:pointer;">&times;</button>`,
            '</div>'
        ].join('');
        placeholder.append(wrapper);
    }

    document.addEventListener('DOMContentLoaded', function () {
        const form = document.getElementById('settings-form');
        const saveButton = document.getElementById('save-button');
        const btnText = document.getElementById('btn-text');
        const btnSpinner = document.getElementById('btn-spinner');
        const alertPlaceholder = document.getElementById('alert-placeholder');

        // Função auxiliar para atualizar UI de status das chaves
        function updateKeyStatusUI(keyStatus) {
            // Recarrega a página para atualizar os valores renderizados pelo Jinja
            // Ou atualiza via DOM se quisermos ser fancy. Recarregar é mais seguro para garantir consistência.
            setTimeout(() => window.location.reload(), 1500);
        }

        form.addEventListener('submit', function (event) {
            event.preventDefault(); // Impede o recarregamento da página

            saveButton.disabled = true;
            btnText.innerText = "Salvando...";
            btnSpinner.classList.remove('d-none');
            alertPlaceholder.innerHTML = '';

            const formData = new FormData(form);

            fetch('{{ url_for("api.api_setup") }}', {
                method: 'POST',
                headers: {'X-Requested-With': 'XMLHttpRequest'},
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.ok) {
                    window.showAlert(data.message, 'success', alertPlaceholder);
                    form.reset(); 
                    if (data.key_status) {
                        updateKeyStatusUI(data.key_status);
                    }
                } else {
                    window.showAlert(data.error || 'Ocorreu um erro desconhecido.', 'danger', alertPlaceholder);
                    saveButton.disabled = false;
                    btnText.innerText = "Salvar Alterações";
                    btnSpinner.classList.add('d-none');
                }
            })
            .catch(error => {
                console.error('Erro:', error);
                window.showAlert('Erro de comunicação com o servidor.', 'danger', alertPlaceholder);
                saveButton.disabled = false;
                btnText.innerText = "Salvar Alterações";
                btnSpinner.classList.add('d-none');
            })
        });
    });
</script>
{% endblock %}
