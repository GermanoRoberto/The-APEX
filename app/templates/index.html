{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1 id="module-title">
        {% if module == 'network' %}Network Monitor{% elif module == 'audit' %}Windows Audit{% elif module == 'soc' %}Alert Correlator{% elif module == 'alerts' %}Alertas Brasil{% else %}Malware Analyzer{% endif %}
    </h1>
    <p style="color: var(--text-secondary);">
        {% if module == 'network' %}Monitoramento de Rede{% elif module == 'audit' %}Auditoria Windows{% elif module == 'soc' %}Correla√ß√£o de Alertas (SOC Lab){% elif module == 'alerts' %}Intelig√™ncia de Amea√ßas Nacionais{% else %}M√≥dulo de Seguran√ßa Ativa{% endif %}
    </p>
</div>

{% if module == 'malware' or not module %}
<div id="module-malware" class="module-section">
    <div class="glass-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(220, 53, 69, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(220, 53, 69, 0.2);">
                <i class="bi bi-bug-fill" style="color: #ff4d4d; font-size: 20px;"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Malware Analyzer</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">An√°lise profunda de artefatos suspeitos</p>
            </div>
        </div>

        <!-- Upload de Arquivo -->
        <div style="margin-bottom: 30px; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üìÅ An√°lise de Arquivo</h4>
                <span id="status-badge-malware" class="status-badge status-idle">Aguardando</span>
            </div>
            <div style="display: flex; gap: 10px; align-items: center;">
                 <select id="ai-provider-malware" class="form-control" style="width: auto; margin-bottom: 0;" disabled title="Provedor de IA configurado automaticamente">
                    <option value="groq" selected>Groq Llama</option>
                 </select>
                <button class="action-btn" onclick="document.getElementById('file-upload').click()" style="flex: 1;">SELECIONAR EXECUT√ÅVEL OU SCRIPT</button>
                <input type="file" id="file-upload" style="display: none" onchange="handleFileSelect(this)">
            </div>
            <div class="console-output" id="output-malware" style="margin-top: 15px; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                <i class="bi bi-info-circle" style="margin-right: 5px;"></i> Suporta .exe, .dll, .py, .ps1, .bin
            </div>
        </div>

        <!-- An√°lise de URL -->
        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üåê An√°lise de URL</h4>
                <span class="status-badge status-idle" id="status-badge-url">Pronto</span>
            </div>
            <div style="display:flex; gap:10px;">
                <input id="url-input" class="form-control" placeholder="https://exemplo.com/malware" style="flex: 1; margin-bottom: 0;">
                <button class="action-btn" onclick="analyzeUrl()">ANALISAR URL</button>
            </div>
            <div class="console-output" id="output-url" style="margin-top: 15px; font-size: 11px; color: var(--text-secondary); background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px;">
                <i class="bi bi-shield-check" style="margin-right: 5px;"></i> Verifica√ß√£o em tempo real com reputa√ß√£o global.
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if module == 'network' %}
<div id="module-network" class="module-section">
    <div class="glass-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(0, 123, 255, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0, 123, 255, 0.2);">
                <i class="bi bi-broadcast-pin" style="color: var(--accent-color); font-size: 20px;"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Network Monitor</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Varredura e enumera√ß√£o de ativos de rede</p>
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <span id="status-badge-network" class="status-badge status-idle">Pronto</span>
                <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
                    <select id="network-mode" class="form-control" style="width: auto;">
                        <option value="quick" selected>R√°pida (descoberta)</option>
                        <option value="full">Completa (portas/servi√ßos)</option>
                    </select>
                    <input id="network-cidr" class="form-control" placeholder="CIDR (ex: 192.168.1.0/24)" style="width: 200px;">
                    <button class="action-btn" onclick="runNetworkScan()">üì° INICIAR SCAN</button>
                </div>
            </div>
            <div class="console-output" id="output-network" style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; min-height: 80px;">
                Aguardando in√≠cio do escaneamento...
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if module == 'alerts' %}
<div id="module-alerts" class="module-section">
    <div class="glass-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(0, 212, 255, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(0, 212, 255, 0.2);">
                <i class="bi bi-geo-alt-fill" style="color: #00d4ff; font-size: 20px;"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Alertas Brasil</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Tend√™ncias e intelig√™ncia de amea√ßas nacionais</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
            <!-- Coluna da Esquerda: Lista de Alertas Oficiais -->
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üì° Alertas Recentes</h4>
                    <span class="status-badge status-idle" id="status-badge-alerts">Pronto</span>
                </div>
                
                <div id="alerts-list-container" style="display: flex; flex-direction: column; gap: 12px; min-height: 200px;">
                    <p style="color: var(--text-secondary); font-size: 13px; text-align: center; padding: 40px 0;">
                        Clique no bot√£o abaixo para buscar os alertas oficiais do ano atual.
                    </p>
                </div>

                <button class="action-btn" onclick="loadBrazilAlerts()" style="width: 100%; margin-top: 20px;">üîé CONSULTAR ALERTAS</button>
            </div>

            <!-- Coluna da Direita: An√°lise Inteligente -->
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px;">
                    <i class="bi bi-robot" style="font-size: 20px; color: #00d4ff;"></i>
                    <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">An√°lise Inteligente</h4>
                </div>
                
                <div id="ai-interpretation-content" style="line-height: 1.6; font-size: 13px; color: var(--text-secondary);">
                    Aguardando consulta para gerar o resumo executivo...
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadBrazilAlerts() {
            const alertsList = document.getElementById('alerts-list-container');
            const badge = document.getElementById('status-badge-alerts');
            const aiContent = document.getElementById('ai-interpretation-content');
            
            badge.className = 'status-badge status-running';
            badge.innerText = 'CONSULTANDO...';
            
            alertsList.innerHTML = `
                <div style="text-align: center; padding: 40px 0;">
                    <div class="spinner-border spinner-border-sm text-info" role="status"></div>
                    <p style="margin-top: 10px; font-size: 12px; color: var(--text-secondary);">Coletando dados oficiais do CTIR Gov...</p>
                </div>`;
                
            aiContent.innerHTML = `
                <div class="placeholder-glow">
                    <span class="placeholder col-12" style="background: rgba(255,255,255,0.05);"></span>
                    <span class="placeholder col-10" style="background: rgba(255,255,255,0.05);"></span>
                    <span class="placeholder col-8" style="background: rgba(255,255,255,0.05);"></span>
                </div>`;

            try {
                // Adicionamos um timestamp para evitar cache do navegador
                const resp = await fetch('/api/threats/brasil?t=' + Date.now(), { method: 'GET' });
                const data = await resp.json();
                
                if (!resp.ok || !data.ok) throw new Error(data.error || 'Erro no servidor');
                
                // 1. Renderiza a lista de alertas (Sempre exibe se houver dados)
                if (data.items && data.items.length > 0) {
                    alertsList.innerHTML = '';
                    data.items.forEach(it => {
                        const card = document.createElement('a');
                        card.href = it.url;
                        card.target = '_blank';
                        card.style.textDecoration = 'none';
                        card.style.display = 'block';
                        card.style.padding = '12px';
                        card.style.background = 'rgba(255,255,255,0.03)';
                        card.style.border = '1px solid var(--glass-border)';
                        card.style.borderRadius = '12px';
                        card.style.transition = 'all 0.2s';
                        
                        card.onmouseover = () => { card.style.borderColor = 'var(--accent-color)'; card.style.background = 'rgba(255,255,255,0.05)'; };
                        card.onmouseout = () => { card.style.borderColor = 'var(--glass-border)'; card.style.background = 'rgba(255,255,255,0.03)'; };
                        
                        const source = 'CTIR';
                        const sourceColor = '#00d4ff';
                        
                        card.innerHTML = `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-size: 10px; font-weight: 700; color: ${sourceColor}; text-transform: uppercase;">${source}</span>
                                <span style="font-size: 10px; color: var(--text-secondary);">${it.date}</span>
                            </div>
                            <div style="font-size: 12px; font-weight: 600; color: #fff; margin-bottom: 5px; line-height: 1.3;">${it.title.split(']')[1] || it.title}</div>
                            <div style="font-size: 11px; color: var(--text-secondary); display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${it.summary}</div>
                        `;
                        alertsList.appendChild(card);
                    });
                } else {
                    alertsList.innerHTML = '<p style="text-align: center; padding: 40px 0; color: var(--text-secondary);">Nenhum alerta encontrado.</p>';
                }

                // 2. Renderiza a interpreta√ß√£o da IA
                if (data.ai_analysis) {
                    aiContent.innerHTML = typeof marked !== 'undefined' ? marked.parse(data.ai_analysis) : data.ai_analysis;
                } else {
                    aiContent.innerHTML = "<p style='color: var(--text-secondary);'>O resumo inteligente n√£o p√¥de ser gerado (limite de uso atingido). Use os links ao lado para detalhes.</p>";
                }

                badge.className = 'status-badge status-success';
                badge.innerText = 'ATUALIZADO';
            } catch(e) {
                console.error(e);
                alertsList.innerHTML = `<p style="color: #ff4d4d; text-align: center; padding: 40px 0;">[ERROR] ${e.message}</p>`;
                aiContent.innerHTML = `<p style="color: var(--text-secondary);">Falha ao obter an√°lise inteligente.</p>`;
                badge.className = 'status-badge status-error';
                badge.innerText = 'FALHA';
            }
        }
    </script>
</div>
{% endif %}

{% if module == 'audit' %}
<div id="module-audit" class="module-section">
    <div class="glass-card">
        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 25px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border);">
            <div style="width: 40px; height: 40px; border-radius: 10px; background: rgba(255, 193, 7, 0.1); display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255, 193, 7, 0.2);">
                <i class="bi bi-shield-lock-fill" style="color: #ffc107; font-size: 20px;"></i>
            </div>
            <div>
                <h3 style="margin: 0; font-size: 16px; font-weight: 600;">Windows Auditor</h3>
                <p style="margin: 0; font-size: 12px; color: var(--text-secondary);">Auditoria de seguran√ßa local e credenciais</p>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Auditoria de Sistema -->
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üõ°Ô∏è Auditoria Completa</h4>
                <span id="status-badge-audit" class="status-badge status-idle">Pronto</span>
            </div>
            <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 20px;">Verifica processos, servi√ßos e configura√ß√µes cr√≠ticas do Windows.</p>
            <button class="action-btn" style="width: 100%;" onclick="runAudit()">üîç INICIAR AUDITORIA</button>
            </div>

            <!-- Auditoria de Vault -->
            <div style="background: rgba(0,0,0,0.2); padding: 20px; border-radius: 16px; border: 1px solid var(--glass-border);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #fff; font-size: 14px; font-weight: 600;">üîë Windows Vault</h4>
                    <span id="status-badge-vault" class="status-badge status-idle">Pronto</span>
                </div>
                <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 20px;">Identifica credenciais armazenadas que podem representar risco.</p>
                <button class="action-btn" style="width: 100%;" onclick="runVaultScan()">ESCANEAR VAULT</button>
            </div>
        </div>

        <div class="console-output" id="output-audit" style="margin-top: 20px; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; min-height: 60px; font-family: 'Fira Code', monospace; font-size: 12px;">
            Aguardando comando...
        </div>
    </div>
</div>
{% endif %}

{% if module == 'soc' %}
<div id="module-soc" class="module-section">
    <div class="hero-card" style="margin-bottom: 20px;">
        <h3>Correla√ß√£o de Alertas</h3>
        <p>Agrupe alertas por entidade (IP, dom√≠nio, hash, hostname), defina janela e limiar para gerar incidentes.</p>
    </div>
    <div class="glass-card">
        <div style="display: grid; grid-template-columns: 1fr 320px; gap: 20px; align-items: start;">
            <div>
                <label class="form-label">Cole um array JSON de alertas</label>
                <textarea id="corr-input" class="form-control" style="height: 220px;"></textarea>
                <div class="text-muted" style="margin-top:6px;">Campos reconhecidos: timestamp, severity, source, ip, domain, hash, hostname, event</div>
            </div>
            <div>
                <label class="form-label">Janela (minutos)</label>
                <input id="corr-window" class="form-control" type="number" value="15">
                <label class="form-label" style="margin-top:10px;">Limiar de correla√ß√£o</label>
                <input id="corr-threshold" class="form-control" type="number" value="3">
                <button class="action-btn" style="margin-top:12px;" onclick="runCorrelation()">Executar Correla√ß√£o</button>
            </div>
        </div>
        <div class="console-output" id="corr-output" style="margin-top: 16px;">Aguardando entrada‚Ä¶</div>
    </div>
    <div class="glass-card">
        <div class="text-muted">Dica: importe alertas do seu SIEM como JSON e ajuste os par√¢metros para reduzir falsos positivos.</div>
    </div>
    <script>
        async function runCorrelation() {
            const output = document.getElementById('corr-output');
            const csrf = document.querySelector('meta[name=\"csrf-token\"]').getAttribute('content');
            let alerts = [];
            try {
                alerts = JSON.parse(document.getElementById('corr-input').value || '[]');
                if (!Array.isArray(alerts)) throw new Error('Entrada deve ser um array JSON');
            } catch(e) {
                output.innerText = '[ERROR] JSON inv√°lido: ' + e.message;
                return;
            }
            const rules = {
                window_minutes: parseInt(document.getElementById('corr-window').value || '15'),
                threshold: parseInt(document.getElementById('corr-threshold').value || '3')
            };
            output.innerText = '[INFO] Executando correla√ß√£o...\n';
            try {
                const resp = await fetch('/api/correlation/alerts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
                    body: JSON.stringify({ alerts, rules })
                });
                const data = await resp.json();
                if (!resp.ok) throw new Error(data.error || 'Erro no servidor');
                output.innerText += '[SUCCESS] ID: ' + data.result_id + '\\nRedirecionando para resultados...';
                setTimeout(() => { window.location.href = '/results/' + data.result_id; }, 900);
            } catch(e) {
                output.innerText += '[ERROR] ' + e.message;
            }
        }
    </script>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const currentModule = "{{ module or 'malware' }}";

    document.addEventListener('DOMContentLoaded', async () => {
        if (currentModule === 'network') {
            try {
                const resp = await fetch('/api/network/local', { method: 'GET' });
                const ct = resp.headers.get('content-type') || '';
                if (resp.ok) {
                    const data = ct.includes('application/json') ? await resp.json() : JSON.parse(await resp.text());
                    const cidrInput = document.getElementById('network-cidr');
                    if (cidrInput && data.cidr) {
                        cidrInput.value = data.cidr;
                    }
                    const output = document.getElementById('output-network');
                    if (output) {
                        output.innerText = `[INFO] IP: ${data.ip} | M√°scara: ${data.mask} | CIDR sugerido: ${data.cidr}\n` + (output.innerText || "");
                    }
                }
            } catch (e) {
                const output = document.getElementById('output-network');
                if (output) output.innerText = `[WARN] Falha ao detectar IP/CIDR automaticamente: ${e.message}\n` + (output.innerText || "");
            }
        }
    });

    async function handleFileSelect(input) {
        if (input.files.length === 0) return;
        
        const file = input.files[0];
        const output = document.getElementById('output-malware');
        const badge = document.getElementById('status-badge-malware');
        const provider = document.getElementById('ai-provider-malware').value;

        output.innerText = `[INFO] Iniciando upload de: ${file.name} (${(file.size/1024).toFixed(2)} KB)...\n`;
        badge.className = 'status-badge status-running';
        badge.innerText = 'ANALISANDO...';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrf_token', csrfToken); // Importante para Quart-WTF/CSRF
        if (provider) formData.append('ai_provider', provider);

        try {
            const response = await fetch('/api/analyze/file', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });

            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                if (contentType.includes('application/json')) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro no servidor');
                } else {
                    const text = await response.text();
                    throw new Error(`Resposta n√£o-JSON do servidor: ${text.substring(0, 200)}...`);
                }
            }

            const data = contentType.includes('application/json') ? await response.json() : JSON.parse(await response.text());
            output.innerText += `[SUCCESS] An√°lise conclu√≠da. ID: ${data.result_id}\nRedirecionando para resultados...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU√çDO';
            
            setTimeout(() => {
                window.location.href = `/results/${data.result_id}`;
            }, 1000);

        } catch (e) {
            output.innerText += `[ERROR] Falha: ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'ERRO';
        }
    }

    async function runNetworkScan() {
        const output = document.getElementById('output-network');
        const badge = document.getElementById('status-badge-network');
        const mode = document.getElementById('network-mode').value;
        const cidr = document.getElementById('network-cidr').value.trim();
        
        output.innerText = "[INFO] Iniciando varredura de rede...\n";
        badge.className = 'status-badge status-running';
        badge.innerText = 'ESCANEANDO...';

        try {
            const response = await fetch('/api/analyze/network', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ mode, cidr: cidr || null })
            });
            
            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                if (contentType.includes('application/json')) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro no servidor');
                } else {
                    const text = await response.text();
                    throw new Error(`Resposta n√£o-JSON do servidor: ${text.substring(0, 200)}...`);
                }
            }
            const data = contentType.includes('application/json') ? await response.json() : JSON.parse(await response.text());
            output.innerText += `[SUCCESS] ID: ${data.result_id}\nRedirecionando para resultados...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'FINALIZADO';
            setTimeout(() => {
                window.location.href = `/results/${data.result_id}`;
            }, 800);
        } catch (e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }

    async function analyzeUrl() {
        const output = document.getElementById('output-url');
        const badge = document.getElementById('status-badge-url');
        const csrf = document.querySelector('meta[name=\"csrf-token\"]').getAttribute('content');
        const url = document.getElementById('url-input').value.trim();
        if (!url) {
            output.innerText = '[WARN] Informe uma URL v√°lida.';
            return;
        }
        output.innerText = `[INFO] Enviando URL: ${url}\n`;
        badge.className = 'status-badge status-running';
        badge.innerText = 'ANALISANDO...';
        try {
            const resp = await fetch('/api/analyze/url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({ url })
            });
            const ct = resp.headers.get('content-type') || '';
            const data = ct.includes('application/json') ? await resp.json() : JSON.parse(await resp.text());
            if (!resp.ok) throw new Error(data.error || 'Erro no servidor');
            output.innerText += `[SUCCESS] ID: ${data.result_id}\nRedirecionando para resultados...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU√çDO';
            setTimeout(() => { window.location.href = `/results/${data.result_id}`; }, 900);
        } catch(e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }

    async function runAudit() {
        const output = document.getElementById('output-audit');
        const badge = document.getElementById('status-badge-audit');
        
        output.innerText = "[INFO] Iniciando auditoria do Windows...\n";
        badge.className = 'status-badge status-running';
        badge.innerText = 'EXECUTANDO...';

        try {
            const response = await fetch('/api/scan/audit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            });
            
            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                if (contentType.includes('application/json')) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro no servidor');
                } else {
                    const text = await response.text();
                    throw new Error(`Resposta n√£o-JSON (${response.status}): ${text.substring(0, 100)}...`);
                }
            }
            
            const data = contentType.includes('application/json') ? await response.json() : JSON.parse(await response.text());
            
            output.innerText += `[SUCCESS] Auditoria conclu√≠da. ID: ${data.analysis_id}\nRedirecionando...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU√çDO';
            
            setTimeout(() => {
                window.location.href = `/results/${data.analysis_id}`;
            }, 1000);
        } catch (e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }

    async function runVaultScan() {
        const output = document.getElementById('output-audit');
        const badge = document.getElementById('status-badge-vault');
        
        output.innerText = "[INFO] Iniciando escaneamento do Windows Vault...\n";
        badge.className = 'status-badge status-running';
        badge.innerText = 'ESCANEANDO...';

        try {
            const response = await fetch('/api/analyze/vault', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            });
            
            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                if (contentType.includes('application/json')) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro no servidor');
                } else {
                    const text = await response.text();
                    throw new Error(`Resposta n√£o-JSON (${response.status}): ${text.substring(0, 100)}...`);
                }
            }
            
            const data = contentType.includes('application/json') ? await response.json() : JSON.parse(await response.text());
            
            output.innerText += `[SUCCESS] Vault scan conclu√≠do. ID: ${data.result_id}\nRedirecionando...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU√çDO';
            
            setTimeout(() => {
                window.location.href = `/results/${data.result_id}`;
            }, 1000);
        } catch (e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }

    
</script>
{% endblock %}
