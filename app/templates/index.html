{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1 id="module-title">
        {% if module == 'network' %}Network Monitor{% elif module == 'audit' %}Windows Audit{% else %}Malware Analyzer{% endif %}
    </h1>
    <p style="color: var(--text-secondary);">
        {% if module == 'network' %}Monitoramento de Rede{% elif module == 'audit' %}Auditoria Windows{% else %}M칩dulo de Seguran칞a Ativa{% endif %}
    </p>
</div>

{% if module == 'malware' or not module %}
<div id="module-malware" class="module-section">
    <div class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <span id="status-badge-malware" class="status-badge status-idle">Aguardando Arquivo</span>
            <div style="display: flex; gap: 10px;">
                 <select id="ai-provider-malware" class="form-control" style="width: auto; margin-bottom: 0;" disabled>
                    <option value="groq" selected>Groq Llama</option>
                 </select>
                <button class="action-btn" onclick="document.getElementById('file-upload').click()">游늬 SELECIONAR ARQUIVO</button>
                <input type="file" id="file-upload" style="display: none" onchange="handleFileSelect(this)">
            </div>
        </div>
        
        <div class="console-output" id="output-malware">
            Fa칞a upload de um execut치vel (.exe, .dll) ou script para an치lise est치tica e verifica칞칚o com IA.
        </div>
    </div>
</div>
{% endif %}

{% if module == 'network' %}
<div id="module-network" class="module-section">
    <div class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <span id="status-badge-network" class="status-badge status-idle">Pronto</span>
            <div style="display: flex; gap: 10px;">
                <select id="network-mode" class="form-control" style="width: auto;">
                    <option value="quick" selected>R치pida (descoberta de dispositivos)</option>
                    <option value="full">Completa (portas e servi칞os)</option>
                </select>
                <input id="network-cidr" class="form-control" placeholder="CIDR (ex: 192.168.1.0/24)" style="width: 240px;">
                <button class="action-btn" onclick="runNetworkScan()">游니 INICIAR SCAN DE REDE</button>
            </div>
        </div>
        <div class="console-output" id="output-network">
            Descoberta de dispositivos na rede e, opcionalmente, varredura de portas e servi칞os.
        </div>
    </div>
</div>
{% endif %}

{% if module == 'audit' %}
<div id="module-audit" class="module-section">
    <div class="glass-card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <span id="status-badge-audit" class="status-badge status-idle">Pronto</span>
            <div style="display:flex; gap:10px;">
                <button class="action-btn" onclick="runAudit()">游눹 EXECUTAR AUDITORIA WINDOWS</button>
            </div>
        </div>
        <div class="console-output" id="output-audit">
            Verifica칞칚o de pol칤ticas de seguran칞a, updates pendentes e configura칞칫es de hardening.
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    const currentModule = "{{ module or 'malware' }}";

    document.addEventListener('DOMContentLoaded', async () => {
        if (currentModule === 'network') {
            try {
                const resp = await fetch('/api/network/local', { method: 'GET' });
                const ct = resp.headers.get('content-type') || '';
                if (resp.ok) {
                    const data = ct.includes('application/json') ? await resp.json() : JSON.parse(await resp.text());
                    const cidrInput = document.getElementById('network-cidr');
                    if (cidrInput && data.cidr) {
                        cidrInput.value = data.cidr;
                    }
                    const output = document.getElementById('output-network');
                    if (output) {
                        output.innerText = `[INFO] IP: ${data.ip} | M치scara: ${data.mask} | CIDR sugerido: ${data.cidr}\n` + (output.innerText || "");
                    }
                }
            } catch (e) {
                const output = document.getElementById('output-network');
                if (output) output.innerText = `[WARN] Falha ao detectar IP/CIDR automaticamente: ${e.message}\n` + (output.innerText || "");
            }
        }
    });

    async function handleFileSelect(input) {
        if (input.files.length === 0) return;
        
        const file = input.files[0];
        const output = document.getElementById('output-malware');
        const badge = document.getElementById('status-badge-malware');
        const provider = document.getElementById('ai-provider-malware').value;

        output.innerText = `[INFO] Iniciando upload de: ${file.name} (${(file.size/1024).toFixed(2)} KB)...\n`;
        badge.className = 'status-badge status-running';
        badge.innerText = 'ANALISANDO...';

        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrf_token', csrfToken); // Importante para Quart-WTF/CSRF
        if (provider) formData.append('ai_provider', provider);

        try {
            const response = await fetch('/api/analyze/file', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            });

            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                if (contentType.includes('application/json')) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro no servidor');
                } else {
                    const text = await response.text();
                    throw new Error(`Resposta n칚o-JSON do servidor: ${text.substring(0, 200)}...`);
                }
            }

            const data = contentType.includes('application/json') ? await response.json() : JSON.parse(await response.text());
            output.innerText += `[SUCCESS] An치lise conclu칤da. ID: ${data.result_id}\nRedirecionando para resultados...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'CONCLU칈DO';
            
            setTimeout(() => {
                window.location.href = `/results/${data.result_id}`;
            }, 1000);

        } catch (e) {
            output.innerText += `[ERROR] Falha: ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'ERRO';
        }
    }

    async function runNetworkScan() {
        const output = document.getElementById('output-network');
        const badge = document.getElementById('status-badge-network');
        const mode = document.getElementById('network-mode').value;
        const cidr = document.getElementById('network-cidr').value.trim();
        
        output.innerText = "[INFO] Iniciando varredura de rede...\n";
        badge.className = 'status-badge status-running';
        badge.innerText = 'ESCANEANDO...';

        try {
            const response = await fetch('/api/analyze/network', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ mode, cidr: cidr || null })
            });
            
            const contentType = response.headers.get('content-type') || '';
            if (!response.ok) {
                if (contentType.includes('application/json')) {
                    const err = await response.json();
                    throw new Error(err.error || 'Erro no servidor');
                } else {
                    const text = await response.text();
                    throw new Error(`Resposta n칚o-JSON do servidor: ${text.substring(0, 200)}...`);
                }
            }
            const data = contentType.includes('application/json') ? await response.json() : JSON.parse(await response.text());
            output.innerText += `[SUCCESS] ID: ${data.result_id}\nRedirecionando para resultados...`;
            badge.className = 'status-badge status-success';
            badge.innerText = 'FINALIZADO';
            setTimeout(() => {
                window.location.href = `/results/${data.result_id}`;
            }, 800);
        } catch (e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }

    async function runAudit() {
        const output = document.getElementById('output-audit');
        const badge = document.getElementById('status-badge-audit');
        
        output.innerText = "[INFO] Iniciando auditoria de sistema...\n";
        badge.className = 'status-badge status-running';
        badge.innerText = 'AUDITANDO...';

        try {
            const response = await fetch('/api/scan/audit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({})
            });
            
            const data = await response.json();
            if (data && data.raw_data) {
                const rd = data.raw_data;
                const status = rd.status || 'OK';
                const badgeColor = status === 'CRITICAL' ? 'bg-danger' : (status === 'ALERT' ? 'bg-warning' : 'bg-success');
                const lines = [
                    `<div style="margin-bottom: 10px;"><span class="badge ${badgeColor}">${status}</span></div>`,
                    `<div style="display: grid; grid-template-columns: 220px 1fr; gap: 10px;">`,
                    rd.machine_name ? `<div style="color: var(--text-secondary); font-weight: 600;">Nome da M치quina</div><div>${rd.machine_name}</div>` : '',
                    rd.ip ? `<div style="color: var(--text-secondary); font-weight: 600;">IP Local</div><div>${rd.ip}</div>` : '',
                    rd.os ? `<div style="color: var(--text-secondary); font-weight: 600;">Sistema Operacional</div><div>${rd.os}</div>` : '',
                    rd.admin_privileges ? `<div style="color: var(--text-secondary); font-weight: 600;">Privil칠gios Administrativos</div><div>${rd.admin_privileges}</div>` : '',
                    rd.firewall ? `<div style="color: var(--text-secondary); font-weight: 600;">Firewall</div><div>${rd.firewall}</div>` : '',
                    rd.uac ? `<div style="color: var(--text-secondary); font-weight: 600;">UAC</div><div>${rd.uac}</div>` : '',
                    `</div>`,
                ];
                if (Array.isArray(rd.programs_recent) && rd.programs_recent.length > 0) {
                    lines.push(`<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">Programas Instalados Recentemente</h4>`);
                    lines.push(`<div style="overflow-x:auto;"><table class="table"><thead><tr><th>Nome</th><th>Publisher</th><th>Data</th><th>Local</th></tr></thead><tbody>`);
                    rd.programs_recent.slice(0,10).forEach(p => {
                        lines.push(`<tr><td>${p.Name||'-'}</td><td>${p.Publisher||'-'}</td><td>${p.InstallDate||p.LastWriteTime||'-'}</td><td>${p.InstallLocation||'-'}</td></tr>`);
                    });
                    lines.push(`</tbody></table></div></div>`);
                }
                if (Array.isArray(rd.startup_entries) && rd.startup_entries.length > 0) {
                    lines.push(`<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">Entradas de Inicializa칞칚o</h4><ul style="list-style:none; padding-left:0;">`);
                    rd.startup_entries.slice(0,15).forEach(e => {
                        lines.push(`<li><strong>${e.Name||'-'}</strong>: <span style="color:var(--text-secondary)">${e.Value||'-'}</span></li>`);
                    });
                    lines.push(`</ul></div>`);
                }
                if (Array.isArray(rd.scheduled_tasks_hidden) && rd.scheduled_tasks_hidden.length > 0) {
                    lines.push(`<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">Tarefas Agendadas Ocultas</h4><ul style="list-style:none; padding-left:0;">`);
                    rd.scheduled_tasks_hidden.slice(0,15).forEach(t => {
                        lines.push(`<li><strong>${t.TaskName||'-'}</strong> (${t.Path||'-'})</li>`);
                    });
                    lines.push(`</ul></div>`);
                }
                if (Array.isArray(rd.suspicious_apps) && rd.suspicious_apps.length > 0) {
                    lines.push(`<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">Apps Suspeitos</h4><ul style="list-style:none; padding-left:0;">`);
                    rd.suspicious_apps.slice(0,10).forEach(s => {
                        lines.push(`<li><span style="color:var(--text-primary)">${s.path}</span> <span class="badge bg-warning">suspeito</span></li>`);
                    });
                    lines.push(`</ul></div>`);
                }
                if (Array.isArray(data.related_analyses) && data.related_analyses.length > 0) {
                    lines.push(`<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">An치lises Enviadas ao Malware Analyzer</h4><ul style="list-style:none; padding-left:0;">`);
                    data.related_analyses.forEach(a => {
                        lines.push(`<li><a href="/results/${a.result_id}" class="action-btn" style="text-decoration:none;">Abrir Relat칩rio (${a.path})</a></li>`);
                    });
                    lines.push(`</ul></div>`);
                }
                if (data.ai_analysis) {
                    lines.push(`<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">An치lise por IA</h4><div style="color: var(--text-primary);">${data.ai_analysis}</div></div>`);
                }
                if (data.ai_reputation) {
                    lines.push(`<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">Reputa칞칚o por Nome de Processo (IA)</h4><div style="color: var(--text-primary);">${data.ai_reputation}</div></div>`);
                }
                output.innerHTML = lines.join('');
            } else {
                output.innerText += JSON.stringify(data, null, 2);
            }
            try {
                const vaultResp = await fetch('/api/analyze/vault', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrfToken }
                });
                const ct = vaultResp.headers.get('content-type') || '';
                if (vaultResp.ok) {
                    const vaultData = ct.includes('application/json') ? await vaultResp.json() : JSON.parse(await vaultResp.text());
                    output.innerHTML += `<div style="margin-top: 15px;"><h4 style="color:#fff; margin:0 0 8px 0;">Windows Vault</h4><div>Relat칩rio salvo automaticamente. <a href="/results/${vaultData.result_id}" class="action-btn" style="text-decoration:none;">Abrir Relat칩rio</a></div></div>`;
                } else {
                    output.innerHTML += `<div style="margin-top: 15px; color: var(--text-secondary);">Falha ao salvar Windows Vault automaticamente.</div>`;
                }
            } catch (e) {
                output.innerHTML += `<div style="margin-top: 15px; color: var(--text-secondary);">Erro ao salvar Windows Vault automaticamente: ${e.message}</div>`;
            }
            badge.className = 'status-badge status-success';
            badge.innerText = 'FINALIZADO';
        } catch (e) {
            output.innerText += `[ERROR] ${e.message}`;
            badge.className = 'status-badge status-error';
            badge.innerText = 'FALHA';
        }
    }
</script>
{% endblock %}
