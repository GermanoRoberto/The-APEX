{% extends "base.html" %}

{% block title %}Análise de Arquivos e URLs{% endblock %}

{% block content %}
<!-- Seção de Cabeçalho (Jumbotron) -->
<div class="p-5 mb-4 bg-body-tertiary rounded-3">
    <div class="container-fluid py-5">
        <h1 class="display-5 fw-bold">Análise de Ameaças com IA</h1>
        <p class="col-md-8 fs-4">Envie um arquivo ou URL para obter um veredito consolidado de múltiplas fontes e uma explicação detalhada gerada por Inteligência Artificial.</p>
    </div>
</div>

<!-- Área para alertas gerais -->
<div id="general-alert-area" class="container mt-3"></div>

<!-- Card Principal de Análise -->
<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="analysis-tabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-file" data-bs-toggle="tab" data-bs-target="#panel-file" type="button" role="tab" aria-controls="panel-file" aria-selected="true">
                    <i class="bi bi-file-earmark-arrow-up"></i> Analisar Arquivo
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-url" data-bs-toggle="tab" data-bs-target="#panel-url" type="button" role="tab" aria-controls="panel-url" aria-selected="false">
                    <i class="bi bi-link-45deg"></i> Analisar URL
                </button>
            </li>
             <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-about" data-bs-toggle="tab" data-bs-target="#panel-about" type="button" role="tab" aria-controls="panel-about" aria-selected="false">
                    <i class="bi bi-info-circle"></i> Como Funciona
                </button>
            </li>
        </ul>
    </div>
    <div class="card-body p-4">
        <div class="tab-content" id="analysis-panels">
            <!-- Painel de Análise de Arquivo -->
            <div class="tab-pane fade show active" id="panel-file" role="tabpanel" aria-labelledby="tab-file">
                <form id="file-form">
                    <div class="mb-3">
                        <label for="file-input" class="form-label">Selecione um arquivo para análise</label>
                        <input class="form-control" type="file" id="file-input" name="file">
                        <div class="form-text">Tamanho máximo: {{ (settings.MAX_FILE_SIZE / 1024 / 1024)|int }} MB. O arquivo não é armazenado, apenas analisado.</div>
                    </div>

                    <button type="submit" id="analyze-file-btn" class="btn btn-primary w-100">
                        <i class="bi bi-play-circle"></i> Iniciar Análise de Arquivo
                    </button>
                </form>
            </div>

            <!-- Painel de Análise de URL -->
            <div class="tab-pane fade" id="panel-url" role="tabpanel" aria-labelledby="tab-url">
                <form id="url-form">
                    <div class="mb-3">
                        <label for="url-input" class="form-label">Informe a URL suspeita</label>
                        <input type="url" class="form-control" id="url-input" name="url" placeholder="https://exemplo.com" required>
                         <div class="form-text">A URL será verificada em fontes de reputação e por IA.</div>
                    </div>

                    <button type="submit" id="analyze-url-btn" class="btn btn-primary w-100">
                        <i class="bi bi-play-circle"></i> Iniciar Análise de URL
                    </button>
                </form>
            </div>

            <!-- Painel "Como Funciona" -->
            <div class="tab-pane fade" id="panel-about" role="tabpanel" aria-labelledby="tab-about">
                <h5 class="card-title">Como o Analisador de Malware trabalha por você</h5>
                <ol class="list-group list-group-numbered">
                    <li class="list-group-item"><strong>Análise local segura:</strong> Identifica tipo, características e strings suspeitas sem executar o conteúdo.</li>
                    <li class="list-group-item"><strong>Consulta a fontes externas:</strong> Hashes e URLs são consultados em serviços como <strong>VirusTotal</strong> e <strong>Google Safe Browsing</strong>.</li>
                    <li class="list-group-item"><strong>Interpretação com IA:</strong> Os resultados são enviados ao <strong>Google Gemini</strong>, que produz uma explicação clara.</li>
                    <li class="list-group-item"><strong>Veredito consolidado:</strong> O sistema combina todos os sinais em um veredito final (Limpo, Suspeito ou Malicioso).</li>
                </ol>
            </div>

             <!-- Painel de Carregamento (Spinner) -->
            <div id="loading-spinner" class="text-center p-5" style="display: none;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Analisando...</span>
                </div>
                <p class="mt-3 fs-5">Analisando... Por favor, aguarde.</p>
                <p class="text-muted">Análises de arquivos novos podem levar mais de um minuto.</p>
            </div>
        </div>
    </div>
    <div class="card-footer text-muted">
        <div class="d-flex justify-content-center gap-3">
            <span class="badge rounded-pill {{ 'text-bg-success' if key_status.VT_API_KEY != 'Não definida' else 'text-bg-secondary' }}">VirusTotal</span>
            <span class="badge rounded-pill {{ 'text-bg-success' if key_status.AI_PROVIDER_DETECTED != 'Não definida' and key_status.AI_PROVIDER_DETECTED != 'Nenhum' else 'text-bg-secondary' }}">IA ({{ key_status.AI_PROVIDER_DETECTED if key_status.AI_PROVIDER_DETECTED != 'Não definida' and key_status.AI_PROVIDER_DETECTED != 'Nenhum' else 'Não definida' }})</span>
            <span class="badge rounded-pill {{ 'text-bg-success' if key_status.GOOGLE_SAFE_BROWSING_API_KEY != 'Não definida' else 'text-bg-secondary' }}">Safe Browsing</span>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/app.js') }}"></script>
{% endblock %}